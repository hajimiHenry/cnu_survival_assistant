# 首都师范大学在校生生存助手 - 技术文档

## 目录

1. [系统架构](#系统架构)
2. [核心模块](#核心模块)
3. [数据流程](#数据流程)
4. [API 接口](#api-接口)
5. [数据结构](#数据结构)
6. [扩展开发](#扩展开发)

---

## 系统架构

### 整体架构图

```
┌─────────────────────────────────────────────────────────────────┐
│                         前端 (Web UI)                            │
│                      static/index.html                          │
│                   拟物化设计 / 响应式布局                         │
└──────────────────────────┬──────────────────────────────────────┘
                           │ HTTP API
┌──────────────────────────▼──────────────────────────────────────┐
│                      Web 服务层                                  │
│                   src/web_server.py                             │
│                 FastAPI + Uvicorn                               │
└──────────────────────────┬──────────────────────────────────────┘
                           │
┌──────────────────────────▼──────────────────────────────────────┐
│                       业务逻辑层                                 │
├─────────────────┬─────────────────┬─────────────────────────────┤
│   意图识别       │    RAG 问答链   │      状态管理               │
│ intent_router   │   rag_chain     │      state                  │
└────────┬────────┴────────┬────────┴────────┬────────────────────┘
         │                 │                 │
┌────────▼─────────────────▼─────────────────▼────────────────────┐
│                       数据层                                     │
├─────────────────┬─────────────────┬─────────────────────────────┤
│   向量存储       │    文档加载     │      配置管理               │
│ vector_store    │    loader       │      config                 │
└────────┬────────┴────────┬────────┴────────┬────────────────────┘
         │                 │                 │
┌────────▼────────┐ ┌──────▼──────┐ ┌────────▼────────┐
│  FAISS Index    │ │  知识库文件  │ │   .env 配置     │
│  index/         │ │  data/       │ │   user_data     │
└─────────────────┘ └─────────────┘ └─────────────────┘
```

### 技术栈

| 层级 | 技术 | 说明 |
|------|------|------|
| 前端 | HTML/CSS/JS | 原生实现，拟物化 UI |
| Web 框架 | FastAPI | 高性能异步 Python 框架 |
| 应用服务器 | Uvicorn | ASGI 服务器 |
| LLM 框架 | LangChain | LLM 应用开发框架 |
| 向量数据库 | FAISS | Facebook 开源向量检索库 |
| 嵌入模型 | Sentence Transformers | HuggingFace 多语言模型 |
| LLM API | OpenAI 兼容 | 支持任意兼容 API |

---

## 核心模块

### 1. 配置管理 (src/config.py)

负责管理系统配置，支持环境变量和运行时配置。

```python
class Config:
    # API 配置
    api_key: str          # API 密钥
    base_url: str         # API 基础地址
    model_name: str       # 模型名称

    # 嵌入模型配置
    embedding_model: str  # 本地嵌入模型名称

    # 路径配置
    data_dir: Path        # 知识库目录
    index_dir: Path       # 向量索引目录
```

**配置优先级**：Web 界面配置 > 环境变量 > 默认值

### 2. 文档加载器 (src/loader.py)

负责加载和解析知识库文档。

**支持的文档格式**：
```
# 条目: 标题
# 类别: 制度/流程/经验/模板
# 主题: 具体主题
# 来源: 资料来源

正文内容...

---

# 条目: 下一条
...
```

**文档元数据**：
- `title`: 条目标题
- `category`: 类别（rules/flows/experience/templates）
- `topic`: 主题关键词
- `source`: 来源信息

### 3. 向量存储 (src/vector_store.py)

管理 FAISS 向量索引的构建和检索。

```python
class VectorStore:
    def build_index(documents: List[Document]) -> None:
        """构建向量索引"""

    def search(query: str, k: int = 3) -> List[Document]:
        """语义搜索相关文档"""

    def load_index() -> None:
        """加载已有索引"""
```

**嵌入模型**：`paraphrase-multilingual-MiniLM-L12-v2`
- 支持 50+ 语言
- 384 维向量
- 本地运行，无 API 调用

### 4. 意图识别 (src/intent_router.py)

基于关键词和规则的意图分类器。

**意图类型**：

| 意图 | 关键词示例 | 回答策略 |
|------|-----------|----------|
| 查规定 | 规定、政策、学分、绩点 | 严谨引用，标注来源 |
| 问流程 | 怎么办、流程、步骤 | 分步说明，提供表单链接 |
| 求经验 | 建议、经验、推荐 | 多角度分析，给出建议 |
| 要模板 | 模板、格式、范文 | 提供可编辑模板 |
| 闲聊 | 你好、谢谢 | 友好回应 |

### 5. RAG 问答链 (src/rag_chain.py)

核心问答逻辑，结合检索和生成。

```python
class RAGChain:
    def answer(question: str, context: dict) -> dict:
        """
        处理用户问题

        Args:
            question: 用户问题
            context: 上下文信息（用户资料、记忆、历史）

        Returns:
            {
                "answer": str,      # 回答内容
                "intent": str,      # 识别的意图
                "new_memories": []  # 新提取的记忆
            }
        """
```

**Prompt 模板结构**：
```
系统角色设定
↓
用户上下文（年级、学院、专业）
↓
长期记忆
↓
检索到的知识库内容
↓
对话历史
↓
当前问题
```

### 6. 状态管理 (src/state.py)

管理用户数据的持久化。

```python
class UserState:
    profile: dict           # 用户资料
    memories: List[dict]    # 长期记忆
    history: List[dict]     # 对话历史

    def save() -> None:
        """保存到 user_data.json"""

    def load() -> None:
        """从文件加载"""
```

### 7. Web 服务 (src/web_server.py)

FastAPI 实现的 RESTful API 服务。

---

## 数据流程

### 问答流程

```
用户输入问题
    │
    ▼
┌─────────────────┐
│   意图识别       │ ← 判断问题类型
└────────┬────────┘
         │
         ▼
┌─────────────────┐
│   向量检索       │ ← 搜索相关知识
└────────┬────────┘
         │
         ▼
┌─────────────────┐
│  构建 Prompt    │ ← 组合上下文
└────────┬────────┘
         │
         ▼
┌─────────────────┐
│   调用 LLM      │ ← 生成回答
└────────┬────────┘
         │
         ▼
┌─────────────────┐
│   记忆提取       │ ← 识别重要信息
└────────┬────────┘
         │
         ▼
    返回响应
```

### 记忆提取流程

```
用户消息 + AI 回复
    │
    ▼
┌─────────────────┐
│  LLM 分析       │ ← 专用 prompt 提取信息
└────────┬────────┘
         │
         ▼
┌─────────────────┐
│  JSON 解析      │ ← 结构化记忆数据
└────────┬────────┘
         │
         ▼
┌─────────────────┐
│  去重保存       │ ← 避免重复记忆
└────────┬────────┘
         │
         ▼
    更新 user_data.json
```

---

## API 接口

### 基础信息

- **基础 URL**: `http://localhost:18080`
- **数据格式**: JSON
- **编码**: UTF-8

### 接口列表

#### 1. 聊天接口

**POST /api/chat**

发送问题并获取回答。

请求体：
```json
{
    "question": "挂科了会怎么样？"
}
```

响应：
```json
{
    "answer": "根据学校规定...",
    "intent": "查规定",
    "new_memories": ["高等数学挂科"]
}
```

#### 2. 用户资料

**GET /api/profile**

获取用户资料。

**PUT /api/profile**

更新用户资料。

#### 3. 长期记忆

**GET /api/memories** - 获取所有记忆

**POST /api/memories** - 添加记忆

**DELETE /api/memories/{index}** - 删除指定记忆

**DELETE /api/memories** - 清空所有记忆

#### 4. 对话历史

**GET /api/history** - 获取对话历史

**DELETE /api/history** - 清空对话历史

#### 5. API 配置

**GET /api/config** - 获取当前配置（密钥脱敏）

**PUT /api/config** - 更新配置

**POST /api/config/test** - 测试连接

---

## 数据结构

### user_data.json

```json
{
    "profile": {
        "grade": "大二",
        "college": "信息工程学院",
        "major": "计算机科学与技术"
    },
    "memories": [
        {
            "content": "高等数学挂科",
            "created_at": "2024-01-15 10:30:00"
        }
    ],
    "history": [
        {
            "role": "user",
            "content": "我高数挂了",
            "timestamp": "2024-01-15 10:30:00"
        },
        {
            "role": "assistant",
            "content": "根据学校规定...",
            "intent": "查规定",
            "timestamp": "2024-01-15 10:30:05"
        }
    ]
}
```

---

## 扩展开发

### 添加新的知识库内容

1. 在 `data/` 对应目录创建 `.txt` 文件
2. 按照规定格式编写内容
3. 运行 `python build_index.py` 重建索引

### 添加新的意图类型

1. 编辑 `src/intent_router.py`
2. 在 `INTENT_KEYWORDS` 添加新意图和关键词
3. 在 `INTENT_PROMPTS` 添加对应的回答策略说明

### 修改 Prompt 模板

编辑 `src/rag_chain.py` 中的 `SYSTEM_PROMPT` 变量。

### 自定义前端样式

编辑 `static/index.html` 中的 `<style>` 部分。

### 更换 LLM 模型

1. 通过 Web 界面设置，或编辑 `.env` 文件
2. 确保 API 地址兼容 OpenAI 格式

### 更换嵌入模型

编辑 `src/config.py` 中的 `EMBEDDING_MODEL` 变量，更换后需重建索引。

---

## 部署建议

### 本地开发

```bash
python run_web.py
```

### 生产环境

建议使用：
- 反向代理（Nginx）
- 进程管理（systemd / PM2）
- HTTPS 证书

---

*文档版本: 1.0*
*更新日期: 2024-12*
